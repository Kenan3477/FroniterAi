generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Voice/Telephony Configuration Models
model InboundNumber {
  id           String   @id @default(cuid())
  phoneNumber  String   @unique // The actual phone number (e.g., "+442046343130")
  displayName  String // Human-readable name (e.g., "UK Local - London")
  description  String? // Custom description for the number
  country      String // Country code (e.g., "GB", "US")
  region       String? // Region/city (e.g., "London", "New York")
  numberType   String   @default("LOCAL") // LOCAL, TOLL_FREE, MOBILE
  provider     String   @default("TWILIO") // TWILIO, PLIVO, etc.
  isActive     Boolean  @default(true)
  capabilities String? // JSON string of capabilities (SMS, VOICE, MMS)
  
  // Audio file configurations for different call conditions
  greetingAudioUrl        String? // Main greeting audio file
  noAnswerAudioUrl        String? // Audio played when call is not answered
  outOfHoursAudioUrl      String? // Audio played when calling outside business hours
  busyAudioUrl           String? // Audio played when all agents are busy
  voicemailAudioUrl      String? // Audio played before voicemail prompt
  
  // Business hours configuration
  businessHoursStart     String? @default("09:00") // Format: "HH:MM"
  businessHoursEnd       String? @default("17:00") // Format: "HH:MM"
  businessDays          String? @default("Monday,Tuesday,Wednesday,Thursday,Friday") // Comma-separated days
  timezone              String? @default("Europe/London") // Timezone for business hours
  
  // Extended configuration for UI form
  businessHours         String? @default("24 Hours") // "24 Hours", "Business Hours Only", "Custom"
  outOfHoursAction      String? @default("Hangup") // "Hangup", "PlayAudio", "Voicemail", "Transfer", "Announcement"
  routeTo               String? @default("Hangup") // "Flow", "Queue", "RingGroup", "Extension", "IVR", "Voicemail", "Hangup"
  outOfHoursTransferNumber String? // Phone number for out of hours transfer
  selectedFlowId        String? // Selected flow ID for routing
  selectedQueueId       String? // Selected queue ID for routing  
  selectedRingGroupId   String? // Selected ring group ID for routing
  selectedExtension     String? // Selected extension for routing
  autoRejectAnonymous   Boolean? @default(true)
  createContactOnAnonymous Boolean? @default(true)
  integration           String? @default("None")
  countryCode           String? @default("United Kingdom Of Great Britain And Northern Ireland (The) (GB)")
  recordCalls           Boolean? @default(true)
  lookupSearchFilter    String? @default("All Lists")
  assignedToDefaultList Boolean? @default(true)
  
  // Queue Routing Configuration
  routeToQueueId         String? // ID of the inbound queue to route calls to
  routeToQueue           InboundQueue? @relation(fields: [routeToQueueId], references: [id])
  
  // Flow Routing Configuration  
  assignedFlowId         String? // ID of the flow to execute for incoming calls
  assignedFlow           Flow? @relation(fields: [assignedFlowId], references: [id])
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("inbound_numbers")
}

// Inbound Queue Management for Call Routing and Distribution
model InboundQueue {
  id           String   @id @default(cuid())
  name         String   @unique // Queue name (e.g., "Customer Service", "Sales", "Support")
  displayName  String // Human-readable name for UI
  description  String? // Queue description
  isActive     Boolean  @default(true)
  
  // Agent Assignment (JSON array of agent IDs/extensions)
  assignedAgents String? // JSON string of assigned agent IDs/extensions
  
  // Business Hours Configuration
  businessHoursEnabled Boolean @default(true)
  businessHoursStart   String? @default("09:00") // Format: "HH:MM"
  businessHoursEnd     String? @default("17:00") // Format: "HH:MM"
  businessDays         String? @default("Monday,Tuesday,Wednesday,Thursday,Friday") // Comma-separated days
  timezone             String? @default("Europe/London") // Timezone for business hours
  
  // Overflow and Out-of-Hours Handling
  maxQueueSize         Int?     @default(50) // Maximum number of callers in queue
  overflowAction       String   @default("voicemail") // voicemail, hangup, transfer, announcement
  overflowDestination  String? // Where to route overflow calls (queue ID, extension, etc.)
  outOfHoursAction     String   @default("voicemail") // What happens outside business hours
  outOfHoursDestination String? // Where to route out-of-hours calls
  
  // Audio Configuration
  holdMusicUrl         String? // Hold music/announcements while waiting
  welcomeMessageUrl    String? // Welcome message when entering queue
  estimatedWaitUrl     String? // Estimated wait time announcement
  
  // Queue Behavior
  ringStrategy         String   @default("round_robin") // round_robin, longest_idle, random, sequential
  callTimeout          Int      @default(30) // Seconds before moving to next agent
  maxWaitTime          Int      @default(300) // Maximum wait time in seconds before overflow
  
  // Priority and Routing
  priority             Int      @default(1) // Queue priority (1-10, higher = more urgent)
  skillTags            String? // JSON array of required skills (for future skill-based routing)
  
  // Relationships
  inboundNumbers       InboundNumber[] // Numbers that route to this queue
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("inbound_queues")
}

model DataList {
  id            String           @id @default(cuid())
  listId        String           @unique
  name          String
  campaignId    String?
  active        Boolean          @default(false)
  blendWeight   Int?
  totalContacts Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  contacts      Contact[]
  queueEntries  DialQueueEntry[]

  @@map("data_lists")
}

model Contact {
  id                String           @id @default(cuid())
  contactId         String           @unique
  listId            String
  firstName         String
  lastName          String
  fullName          String?
  title             String? // Mr, Mrs, Ms, etc.
  phone             String
  mobile            String?
  workPhone         String?
  homePhone         String?
  email             String?
  company           String?
  jobTitle          String?
  department        String?
  industry          String?
  address           String?
  address2          String?
  address3          String? // Additional address line
  city              String?
  state             String? // Maps to county from Excel
  zipCode           String? // Maps to postcode from Excel
  country           String?
  website           String?
  linkedIn          String?
  notes             String?
  tags              String?
  leadSource        String?
  deliveryDate      DateTime? // From delivery_date in Excel
  ageRange          String? // From age_range in Excel
  residentialStatus String? // From residential_status in Excel
  custom1           String? // Available for additional data
  custom2           String? // Available for additional data
  custom3           String?
  custom4           String?
  custom5           String?
  status            String           @default("new")
  attemptCount      Int              @default(0)
  maxAttempts       Int              @default(3)
  lastAgentId       String? // Track which agent last called this lead
  lastOutcome       String? // Last call outcome (answered, no-answer, busy, etc.)
  locked            Boolean          @default(false)
  lockedBy          String?
  lockedAt          DateTime?
  lastAttempt       DateTime? // Last call attempt timestamp
  nextAttempt       DateTime? // Next scheduled attempt
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  callRecords       CallRecord[] // Full call history
  inboundCalls      InboundCall[] // Inbound calls from this contact
  list              DataList         @relation(fields: [listId], references: [listId], onDelete: Cascade)
  queueEntries      DialQueueEntry[]
  interactions      Interaction[]
  sales             Sale[]
  tasks             Task[]
  workItems         WorkItem[]
  callKPIs          CallKPI[]
  leadScore         LeadScore? // AI-generated lead scoring

  @@map("contacts")
}

model DialQueueEntry {
  id              String    @id @default(cuid())
  queueId         String    @unique
  campaignId      String
  listId          String
  contactId       String
  status          String    @default("queued")
  assignedAgentId String?
  priority        Int       @default(100)
  queuedAt        DateTime  @default(now())
  dialedAt        DateTime?
  completedAt     DateTime?
  outcome         String?
  notes           String?
  contact         Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  list            DataList  @relation(fields: [listId], references: [listId], onDelete: Cascade)

  @@map("dial_queue")
}

model Campaign {
  id                   String                    @id @default(cuid())
  campaignId           String                    @unique
  name                 String
  dialMethod           String                    @default("Progressive")
  speed                Float                     @default(2.0)
  dropPercentage       Float                     @default(0.0)
  status               String                    @default("Inactive")
  description          String?
  maxLines             Int?
  dialRatio            Float?
  recordCalls          Boolean                   @default(false)
  allowTransfers       Boolean                   @default(false)
  campaignScript       String?
  fieldMapping         String?
  retrySettings        String?
  hoursOfOperation     String?
  abandonRateThreshold Float?                    @default(0.05)
  pacingMultiplier     Float?                    @default(1.0)
  maxCallsPerAgent     Int?                      @default(1)
  outboundNumber       String? // CLI (Caller Line Identification) number
  isActive             Boolean                   @default(false)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  createdById          Int?
  agentAssignments     AgentCampaignAssignment[]
  callRecords          CallRecord[]
  campaignDispositions CampaignDisposition[]
  createdBy            User?                     @relation("CampaignCreator", fields: [createdById], references: [id])
  interactions         Interaction[]
  tasks                Task[]
  workItems            WorkItem[]
  callKPIs             CallKPI[]
  userAssignments      UserCampaignAssignment[]  @relation("CampaignUserAssignments")
  alerts               Alert[] // Alerts related to this campaign

  @@map("campaigns")
}

model Agent {
  id                  String                    @id @default(cuid())
  agentId             String                    @unique
  firstName           String
  lastName            String
  email               String                    @unique
  status              String                    @default("Offline")
  lastStatusChange    DateTime                  @default(now())
  extension           String?
  skills              String?
  isLoggedIn          Boolean                   @default(false)
  currentCall         String?
  sipUsername         String?
  sipPassword         String?
  maxConcurrentCalls  Int                       @default(1)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  campaignAssignments AgentCampaignAssignment[]
  callRecords         CallRecord[]
  inboundCalls        InboundCall[] // Inbound calls handled by this agent
  interactions        Interaction[]
  sales               Sale[]
  tasks               Task[]
  workItems           WorkItem[]
  callKPIs            CallKPI[]
  callAnalyses        CallAnalysis[] // Sentiment analysis for agent's calls
  alerts              Alert[] // Alerts related to this agent
  qualityMonitoring   QualityMonitoring[] // Quality monitoring records

  @@map("agents")
}

model AgentCampaignAssignment {
  id         String   @id @default(cuid())
  agentId    String
  campaignId String
  isActive   Boolean  @default(true)
  assignedAt DateTime @default(now())
  campaign   Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  agent      Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)

  @@unique([agentId, campaignId])
  @@map("agent_campaign_assignments")
}

model WorkItem {
  id          String    @id @default(cuid())
  workItemId  String    @unique
  agentId     String
  campaignId  String
  contactId   String
  callId      String?
  status      String    @default("active")
  contactData String?
  scriptData  String?
  startTime   DateTime  @default(now())
  endTime     DateTime?
  contact     Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  campaign    Campaign  @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  agent       Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)

  @@map("work_items")
}

model Disposition {
  id                   String                @id @default(cuid())
  name                 String
  description          String?
  category             String?
  isActive             Boolean               @default(true)
  retryEligible        Boolean               @default(false)
  retryDelay           Int?
  createdAt            DateTime              @default(now())
  callRecords          CallRecord[]
  campaignDispositions CampaignDisposition[]
  dispositionTracking  DispositionTracking[] // Phase 3: AI tracking

  @@map("dispositions")
}

model CampaignDisposition {
  id            String      @id @default(cuid())
  campaignId    String
  dispositionId String
  isRequired    Boolean     @default(false)
  sortOrder     Int         @default(0)
  disposition   Disposition @relation(fields: [dispositionId], references: [id], onDelete: Cascade)
  campaign      Campaign    @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)

  @@unique([campaignId, dispositionId])
  @@map("campaign_dispositions")
}

model CallKPI {
  id                  String   @id @default(cuid())
  campaignId          String
  agentId             String
  contactId           String
  callId              String   @unique
  disposition         String
  dispositionCategory String // positive, neutral, negative
  callDuration        Int // seconds
  callDate            DateTime
  hourOfDay           Int // 0-23
  dayOfWeek           Int // 0-6 (Sunday=0)
  listId              String?
  outcome             String
  notes               String?
  createdAt           DateTime @default(now())
  agent               Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  campaign            Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact             Contact  @relation(fields: [contactId], references: [contactId], onDelete: Cascade)

  @@map("call_kpis")
}

model CallRecord {
  id            String       @id @default(cuid())
  callId        String       @unique
  campaignId    String
  contactId     String
  agentId       String?
  phoneNumber   String
  dialedNumber  String?
  callType      String       @default("outbound")
  startTime     DateTime
  endTime       DateTime?
  duration      Int?
  outcome       String?
  dispositionId String?
  notes         String?
  recording     String?
  transferTo    String?
  createdAt     DateTime     @default(now())
  disposition   Disposition? @relation(fields: [dispositionId], references: [id])
  agent         Agent?       @relation(fields: [agentId], references: [agentId])
  contact       Contact      @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  campaign      Campaign     @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  recordingFile Recording? // One-to-one relation
  analysis      CallAnalysis? // Sentiment analysis for this call
  alerts        Alert[] // Alerts related to this call
  qualityMonitoring QualityMonitoring[] // Quality monitoring for this call
  
  // Phase 3: AI Dialler Relations
  sentimentAnalysis SentimentAnalysis[]
  aiRecommendations AiRecommendation[]
  dispositionTracking DispositionTracking[]
  automationTriggers AutomationTrigger[]

  @@map("call_records")
}

model InboundCall {
  id                String    @id @default(cuid())
  callId            String    @unique // Our internal ID
  callSid           String    @unique // Twilio Call SID
  callerNumber      String    // Phone number of caller
  contactId         String? // Link to contact if found
  status            String    @default("ringing") // ringing, queued, answered, transferred, ended
  assignedAgentId   String? // Agent handling the call
  assignedQueueId   String? // Queue if transferred
  routingMetadata   String? // JSON metadata for routing decisions
  isCallback        Boolean   @default(false) // Is this a callback from recent outbound?
  priority          String    @default("normal") // normal, high, urgent
  duration          Int? // Call duration in seconds
  createdAt         DateTime  @default(now())
  answeredAt        DateTime?
  endedAt           DateTime?
  
  // Relations
  contact           Contact?  @relation(fields: [contactId], references: [contactId])
  assignedAgent     Agent?    @relation(fields: [assignedAgentId], references: [agentId])

  @@map("inbound_calls")
}

model Interaction {
  id              String    @id @default(cuid())
  agentId         String
  contactId       String
  campaignId      String
  channel         String    @default("voice")
  outcome         String
  isDmc           Boolean   @default(false)
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  result          String?
  campaign        Campaign  @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact         Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  agent           Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  sales           Sale[]

  @@map("interactions")
}

model Sale {
  id            String      @id @default(cuid())
  interactionId String
  contactId     String
  agentId       String
  amount        Float
  status        String      @default("success")
  createdAt     DateTime    @default(now())
  agent         Agent       @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  contact       Contact     @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  interaction   Interaction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  @@map("sales")
}

model Task {
  id             String   @id @default(cuid())
  assignedUserId String
  contactId      String
  campaignId     String
  type           String   @default("callback")
  notes          String?
  dueAt          DateTime
  status         String   @default("open")
  createdAt      DateTime @default(now())
  campaign       Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact        Contact  @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  assignedUser   Agent    @relation(fields: [assignedUserId], references: [agentId], onDelete: Cascade)

  @@map("tasks")
}

model User {
  id                   Int       @id @default(autoincrement())
  username             String    @unique
  email                String    @unique
  password             String // bcrypt hashed password
  firstName            String
  lastName             String
  name                 String // computed: firstName + " " + lastName
  role                 String    @default("AGENT") // ADMIN, SUPERVISOR, AGENT
  isActive             Boolean   @default(true)
  lastLogin            DateTime?
  lastLoginAttempt     DateTime?
  failedLoginAttempts  Int       @default(0)
  accountLockedUntil   DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?
  twoFactorSecret      String?
  twoFactorEnabled     Boolean   @default(false)
  refreshTokenVersion  Int       @default(0) // for JWT refresh token invalidation
  preferences          String? // JSON string for user preferences
  status               String    @default("away")
  statusSince          DateTime  @default(now())
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  createdCampaigns      Campaign[]             @relation("CampaignCreator")
  channelActivities     ChannelActivity[]      @relation("ChannelActivityUser")
  assignedChannels      ChannelAssignment[]    @relation("ChannelAssigner")
  channelAssignments    ChannelAssignment[]    @relation("ChannelUserAssignment")
  channelConfigurations ChannelConfiguration[] @relation("ChannelConfigCreator")
  channelSchedules      ChannelSchedule[]      @relation("ChannelScheduleCreator")
  updatedChannels       Channel[]              @relation("ChannelUpdater")
  createdChannels       Channel[]              @relation("ChannelCreator")
  flows                 Flow[]
  refreshTokens         RefreshToken[]
  integrations          Integration[]          @relation("UserIntegrations")
  webhooks              Webhook[]              @relation("UserWebhooks")
  notifications         Notification[]         @relation("UserNotifications")
  acknowledgedAlerts    SystemAlert[]          @relation("AlertAcknowledger")
  resolvedAlerts        SystemAlert[]          @relation("AlertResolver")
  emailVerifications    EmailVerification[] // Email verification tokens
  campaignAssignments   UserCampaignAssignment[] @relation("UserCampaignAssignments")
  assignedCampaigns     UserCampaignAssignment[] @relation("CampaignAssigner")
  approvedFlowVersions  FlowVersion[]       @relation("FlowVersionApprover")
  performedRollbacks    FlowVersionRollback[]
  
  // Multi-tenant flow management relations
  createdTemplates      FlowTemplate[]      @relation("FlowTemplateCreator")
  flowPermissions       FlowPermission[]    @relation("FlowPermissionUser")
  grantedPermissions    FlowPermission[]    @relation("FlowPermissionGranter")
  sharedFlows           FlowShare[]         @relation("FlowSharedBy")

  @@map("users")
}

model UserCampaignAssignment {
  id         String   @id @default(cuid())
  userId     Int
  campaignId String
  isActive   Boolean  @default(true)
  assignedAt DateTime @default(now())
  assignedBy Int? // Admin who assigned this campaign
  user       User     @relation("UserCampaignAssignments", fields: [userId], references: [id], onDelete: Cascade)
  campaign   Campaign @relation("CampaignUserAssignments", fields: [campaignId], references: [campaignId], onDelete: Cascade)
  assignedByUser User? @relation("CampaignAssigner", fields: [assignedBy], references: [id])

  @@unique([userId, campaignId])
  @@map("user_campaign_assignments")
}

// DNC (Do Not Call) Management Model
model DncNumber {
  id             Int      @id @default(autoincrement())
  phoneNumber    String   @unique @db.VarChar(20) // Normalized number (e.g., "+1234567890")
  originalFormat String   @db.VarChar(30) // Original format (e.g., "(123) 456-7890")
  reason         String?  @db.Text // Reason for adding to DNC list
  addedBy        String   @db.VarChar(255) // Who added this number
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([phoneNumber])
  @@index([createdAt])
  @@map("dnc_numbers")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime  @default(now())
  lastUsed  DateTime?
  isRevoked Boolean   @default(false)
  userAgent String?
  ipAddress String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Flow {
  id              String        @id @default(cuid())
  name            String
  description     String
  status          String        @default("INACTIVE")
  createdByUserId Int
  organizationId  String?       // Multi-tenant support - optional for backward compatibility
  visibility      String        @default("PRIVATE") // PRIVATE, ORG_PUBLIC, GLOBAL_PUBLIC
  isTemplate      Boolean       @default(false) // Whether this flow is a reusable template
  templateSource  String?       // ID of the template this flow was created from
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  versions        FlowVersion[]
  createdBy       User          @relation(fields: [createdByUserId], references: [id])
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedNumbers InboundNumber[] // Inbound numbers using this flow
  permissions     FlowPermission[]
  shares          FlowShare[]

  @@index([organizationId])
  @@index([organizationId, visibility])
  @@map("flows")
}

model FlowVersion {
  id               String               @id @default(cuid())
  flowId           String
  versionNumber    Int
  isActive         Boolean              @default(false)
  isDraft          Boolean              @default(true)
  createdAt        DateTime             @default(now())
  publishedAt      DateTime?
  archivedAt       DateTime?
  rollbackReason   String?
  changeLog        String?              // JSON string describing changes
  approvedBy       Int?                 // User who approved this version
  approvedAt       DateTime?
  performance      String?              // JSON string with performance metrics
  edges            FlowEdge[]
  nodes            FlowNode[]
  runs             FlowRun[]
  rollbacks        FlowVersionRollback[] @relation("RolledBackFrom")
  rolledBackTo     FlowVersionRollback[] @relation("RolledBackTo")
  flow             Flow                 @relation(fields: [flowId], references: [id], onDelete: Cascade)
  approver         User?                @relation("FlowVersionApprover", fields: [approvedBy], references: [id])

  @@unique([flowId, versionNumber])
  @@map("flow_versions")
}

model FlowNode {
  id            String      @id @default(cuid())
  flowVersionId String
  type          String
  label         String
  category      String
  x             Float
  y             Float
  config        String
  isEntry       Boolean     @default(false)
  targetEdges   FlowEdge[]  @relation("TargetNode")
  sourceEdges   FlowEdge[]  @relation("SourceNode")
  flowVersion   FlowVersion @relation(fields: [flowVersionId], references: [id], onDelete: Cascade)

  @@map("flow_nodes")
}

model FlowEdge {
  id            String      @id @default(cuid())
  flowVersionId String
  sourceNodeId  String
  targetNodeId  String
  sourcePort    String
  label         String?
  targetNode    FlowNode    @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)
  sourceNode    FlowNode    @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  flowVersion   FlowVersion @relation(fields: [flowVersionId], references: [id], onDelete: Cascade)

  @@map("flow_edges")
}

model NodeTypeDefinition {
  id          String  @id @default(cuid())
  type        String  @unique
  category    String
  displayName String
  icon        String?
  schema      String
  ports       String

  @@map("node_type_definitions")
}

model FlowRun {
  id                String        @id @default(cuid())
  flowVersionId     String
  externalReference String?
  status            String        @default("RUNNING")
  startedAt         DateTime      @default(now())
  finishedAt        DateTime?
  context           String
  steps             FlowRunStep[]
  flowVersion       FlowVersion   @relation(fields: [flowVersionId], references: [id])

  @@map("flow_runs")
}

model FlowRunStep {
  id         String    @id @default(cuid())
  flowRunId  String
  nodeId     String
  status     String    @default("PENDING")
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  output     String?
  flowRun    FlowRun   @relation(fields: [flowRunId], references: [id], onDelete: Cascade)

  @@map("flow_run_steps")
}

model FlowVersionRollback {
  id                String      @id @default(cuid())
  fromVersionId     String      // Version being rolled back from
  toVersionId       String      // Version being rolled back to
  reason            String      // Reason for rollback
  performedBy       Int         // User who performed rollback
  performedAt       DateTime    @default(now())
  impactAnalysis    String?     // JSON string with rollback impact analysis
  
  fromVersion       FlowVersion @relation("RolledBackFrom", fields: [fromVersionId], references: [id])
  toVersion         FlowVersion @relation("RolledBackTo", fields: [toVersionId], references: [id])
  performer         User        @relation(fields: [performedBy], references: [id])

  @@map("flow_version_rollbacks")
}

model Organization {
  id          String    @id @default(cuid())
  name        String    @unique
  displayName String
  description String?
  website     String?
  industry    String?
  size        String?
  timezone    String    @default("UTC")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Multi-tenant flow management
  flows       Flow[]
  flowTemplates FlowTemplate[]
  sharedFlows FlowShare[] @relation("FlowSharedWithOrg")
  analytics   OrganizationAnalytics[] @relation("OrganizationAnalytics")
  
  channels    Channel[]

  @@map("organizations")
}

model Team {
  id                 String              @id @default(cuid())
  name               String              @unique
  displayName        String
  description        String?
  department         String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  channelAssignments ChannelAssignment[] @relation("ChannelTeamAssignment")

  @@map("teams")
}

model Role {
  id                 String              @id @default(cuid())
  name               String              @unique
  displayName        String
  description        String?
  permissions        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  channelAssignments ChannelAssignment[] @relation("ChannelRoleAssignment")

  @@map("roles")
}

model Channel {
  id                 String                 @id @default(cuid())
  name               String                 @unique
  displayName        String
  description        String?
  type               String
  status             String                 @default("ACTIVE")
  priority           Int                    @default(1)
  isInbound          Boolean                @default(true)
  isOutbound         Boolean                @default(true)
  isBlended          Boolean                @default(false)
  maxConcurrentCalls Int                    @default(100)
  maxQueueSize       Int                    @default(1000)
  maxWaitTime        Int                    @default(300)
  predictiveMode     Boolean                @default(false)
  progressiveMode    Boolean                @default(true)
  previewMode        Boolean                @default(false)
  manualMode         Boolean                @default(false)
  dialingRatio       Float                  @default(1.0)
  abandonThreshold   Float                  @default(0.05)
  pacingMultiplier   Float                  @default(1.0)
  timezone           String                 @default("UTC")
  dialingStart       String?
  dialingEnd         String?
  dncCompliance      Boolean                @default(true)
  tcpaCompliance     Boolean                @default(true)
  gdprCompliance     Boolean                @default(true)
  callRecording      Boolean                @default(true)
  qualityMonitoring  Boolean                @default(true)
  screenRecording    Boolean                @default(false)
  slaAnswerTime      Int?
  slaResolutionTime  Int?
  slaEscalationTime  Int?
  tags               String?
  customFields       String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  createdBy          Int?
  updatedBy          Int?
  organizationId     String
  activities         ChannelActivity[]
  assignments        ChannelAssignment[]
  capacities         ChannelCapacity[]
  configurations     ChannelConfiguration[]
  metrics            ChannelMetrics[]
  routes             ChannelRoute[]
  schedules          ChannelSchedule[]
  updater            User?                  @relation("ChannelUpdater", fields: [updatedBy], references: [id])
  creator            User?                  @relation("ChannelCreator", fields: [createdBy], references: [id])
  organization       Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("channels")
}

model ChannelRoute {
  id              String   @id @default(cuid())
  name            String
  displayName     String
  description     String?
  routeType       String
  priority        Int      @default(1)
  isActive        Boolean  @default(true)
  conditions      String
  actions         String
  fallbackRoute   String?
  loadBalancing   String   @default("ROUND_ROBIN")
  weightingFactor Float    @default(1.0)
  maxConcurrent   Int      @default(10)
  timeoutSeconds  Int      @default(30)
  retryAttempts   Int      @default(3)
  businessHours   String?
  holidaySchedule String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  channelId       String
  channel         Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([routeType])
  @@index([priority])
  @@index([isActive])
  @@map("channel_routes")
}

model ChannelConfiguration {
  id          String   @id @default(cuid())
  configType  String
  name        String
  description String?
  settings    String
  parameters  String?
  validation  String?
  version     String   @default("1.0.0")
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  environment String   @default("PRODUCTION")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   Int?
  channelId   String
  creator     User?    @relation("ChannelConfigCreator", fields: [createdBy], references: [id])
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, configType, name])
  @@index([channelId])
  @@index([configType])
  @@index([environment])
  @@map("channel_configurations")
}

model ChannelSchedule {
  id            String    @id @default(cuid())
  name          String
  description   String?
  scheduleType  String
  timezone      String    @default("UTC")
  startTime     String
  endTime       String
  daysOfWeek    String
  dates         String?
  exceptions    String?
  maxConcurrent Int?
  maxQueue      Int?
  dialingRatio  Float?
  isActive      Boolean   @default(true)
  priority      Int       @default(1)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     Int?
  channelId     String
  creator       User?     @relation("ChannelScheduleCreator", fields: [createdBy], references: [id])
  channel       Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([scheduleType])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@map("channel_schedules")
}

model ChannelCapacity {
  id                   String   @id @default(cuid())
  capacityType         String
  maxConcurrent        Int
  currentUtilization   Int      @default(0)
  peakUtilization      Int      @default(0)
  averageUtilization   Float    @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  droppedCalls         Int      @default(0)
  abandonedCalls       Int      @default(0)
  averageWaitTime      Float    @default(0)
  averageHandleTime    Float    @default(0)
  averageHoldTime      Float    @default(0)
  firstCallResolution  Float    @default(0)
  customerSatisfaction Float    @default(0)
  agentUtilization     Float    @default(0)
  periodStart          DateTime
  periodEnd            DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  channelId            String
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([capacityType])
  @@index([periodStart])
  @@index([periodEnd])
  @@map("channel_capacities")
}

model ChannelAssignment {
  id                   String   @id @default(cuid())
  assignmentType       String
  priority             Int      @default(1)
  isActive             Boolean  @default(true)
  maxConcurrent        Int?
  skillRequirement     String?
  scheduleOverride     String?
  availabilityWindow   String?
  minimumExperience    Int?
  performanceThreshold Float?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  assignedAt           DateTime @default(now())
  assignedBy           Int?
  channelId            String
  userId               Int?
  teamId               String?
  roleId               String?
  assigner             User?    @relation("ChannelAssigner", fields: [assignedBy], references: [id])
  role                 Role?    @relation("ChannelRoleAssignment", fields: [roleId], references: [id], onDelete: Cascade)
  team                 Team?    @relation("ChannelTeamAssignment", fields: [teamId], references: [id], onDelete: Cascade)
  user                 User?    @relation("ChannelUserAssignment", fields: [userId], references: [id], onDelete: Cascade)
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([assignmentType])
  @@index([userId])
  @@index([teamId])
  @@index([roleId])
  @@index([assignedAt])
  @@map("channel_assignments")
}

model ChannelMetrics {
  id                   String   @id @default(cuid())
  metricType           String
  totalCalls           Int      @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  droppedCalls         Int      @default(0)
  abandonedCalls       Int      @default(0)
  inboundCalls         Int      @default(0)
  outboundCalls        Int      @default(0)
  peakConcurrent       Int      @default(0)
  averageConcurrent    Float    @default(0)
  totalCallDuration    Int      @default(0)
  averageCallDuration  Float    @default(0)
  totalWaitTime        Int      @default(0)
  averageWaitTime      Float    @default(0)
  totalHandleTime      Int      @default(0)
  averageHandleTime    Float    @default(0)
  serviceLevel         Float    @default(0)
  abandonRate          Float    @default(0)
  firstCallResolution  Float    @default(0)
  transferRate         Float    @default(0)
  agentUtilization     Float    @default(0)
  channelUtilization   Float    @default(0)
  costPerCall          Float    @default(0)
  revenuePerCall       Float    @default(0)
  customerSatisfaction Float    @default(0)
  netPromoterScore     Float    @default(0)
  complaintsReceived   Int      @default(0)
  complimentsReceived  Int      @default(0)
  periodType           String
  periodStart          DateTime
  periodEnd            DateTime
  calculatedAt         DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  channelId            String
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([metricType])
  @@index([periodType])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([calculatedAt])
  @@map("channel_metrics")
}

model ChannelActivity {
  id            String   @id @default(cuid())
  activityType  String
  description   String
  details       String?
  oldValues     String?
  newValues     String?
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  impactLevel   String   @default("LOW")
  affectedUsers Int      @default(0)
  timestamp     DateTime @default(now())
  channelId     String
  userId        Int?
  user          User?    @relation("ChannelActivityUser", fields: [userId], references: [id])
  channel       Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([activityType])
  @@index([timestamp])
  @@index([userId])
  @@index([impactLevel])
  @@map("channel_activities")
}

// ============================================================================
// INTEGRATION MANAGEMENT MODELS
// ============================================================================

model Integration {
  id            String    @id @default(cuid())
  name          String
  type          String // "CRM", "EMAIL", "SMS", "WEBHOOK", "API"
  description   String?
  provider      String // "Salesforce", "HubSpot", "Twilio", etc.
  isActive      Boolean   @default(true)
  configuration String // JSON configuration
  credentials   String? // Encrypted credentials
  lastSync      DateTime?
  syncStatus    String    @default("inactive") // "active", "inactive", "error", "syncing"
  errorMessage  String?
  createdBy     Int
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  creator  User             @relation("UserIntegrations", fields: [createdBy], references: [id])
  webhooks Webhook[]
  syncLogs IntegrationLog[]

  @@map("integrations")
}

model IntegrationLog {
  id               String   @id @default(cuid())
  integrationId    String
  action           String // "sync", "send", "receive", "error"
  status           String // "success", "error", "warning"
  message          String
  details          String? // JSON details
  recordsProcessed Int?
  errorCount       Int?
  duration         Int? // milliseconds
  timestamp        DateTime @default(now())

  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([timestamp])
  @@index([status])
  @@map("integration_logs")
}

model Webhook {
  id            String   @id @default(cuid())
  name          String
  url           String
  secret        String? // Webhook signature secret
  events        String // JSON array of event types
  isActive      Boolean  @default(true)
  integrationId String?
  retryPolicy   String? // JSON retry configuration
  headers       String? // JSON custom headers
  createdBy     Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  creator     User              @relation("UserWebhooks", fields: [createdBy], references: [id])
  integration Integration?      @relation(fields: [integrationId], references: [id])
  deliveries  WebhookDelivery[]

  @@map("webhooks")
}

model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  eventType    String
  payload      String // JSON payload
  status       String // "pending", "success", "failed", "retrying"
  responseCode Int?
  responseBody String?
  attemptCount Int       @default(0)
  maxAttempts  Int       @default(3)
  nextRetry    DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime  @default(now())

  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetry])
  @@map("webhook_deliveries")
}

// ============================================================================
// CALL RECORDING & TRANSCRIPTION MODELS
// ============================================================================

model Recording {
  id           String   @id @default(cuid())
  callRecordId String
  fileName     String
  filePath     String // Storage path/URL
  fileSize     Int? // bytes
  duration     Int? // seconds
  format       String   @default("wav") // "wav", "mp3", "m4a"
  quality      String   @default("standard") // "low", "standard", "high"
  storageType  String   @default("local") // "local", "s3", "azure", "gcs"
  isEncrypted  Boolean  @default(false)
  uploadStatus String   @default("pending") // "pending", "uploading", "completed", "failed"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  callRecord     CallRecord      @relation(fields: [callRecordId], references: [id], onDelete: Cascade)
  transcriptions Transcription[]

  @@unique([callRecordId])
  @@index([uploadStatus])
  @@map("recordings")
}

model Transcription {
  id             String   @id @default(cuid())
  recordingId    String
  provider       String // "openai", "google", "aws", "azure"
  language       String   @default("en")
  text           String // Full transcription text
  segments       String? // JSON array of timed segments
  confidence     Float? // Overall confidence score
  wordCount      Int?
  processingTime Int? // milliseconds
  cost           Float? // Processing cost
  status         String   @default("pending") // "pending", "processing", "completed", "failed"
  errorMessage   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  recording Recording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  @@unique([recordingId])
  @@index([status])
  @@index([language])
  @@map("transcriptions")
}

// ============================================================================
// NOTIFICATION & ALERT MODELS
// ============================================================================

model Notification {
  id          String    @id @default(cuid())
  userId      Int
  title       String
  message     String
  type        String    @default("info") // "info", "warning", "error", "success"
  category    String? // "system", "campaign", "call", "task"
  priority    String    @default("normal") // "low", "normal", "high", "urgent"
  isRead      Boolean   @default(false)
  actionUrl   String? // Optional URL for action
  actionLabel String? // Optional action button label
  metadata    String? // JSON additional data
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

model SystemAlert {
  id             String    @id @default(cuid())
  title          String
  message        String
  alertType      String // "system_down", "high_cpu", "queue_overflow", "integration_error"
  severity       String // "low", "medium", "high", "critical"
  status         String    @default("active") // "active", "acknowledged", "resolved"
  source         String? // Component or service that triggered the alert
  metadata       String? // JSON additional data
  acknowledgedBy Int?
  acknowledgedAt DateTime?
  resolvedBy     Int?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())

  acknowledger User? @relation("AlertAcknowledger", fields: [acknowledgedBy], references: [id])
  resolver     User? @relation("AlertResolver", fields: [resolvedBy], references: [id])

  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("system_alerts")
}

// AUDIT & COMPLIANCE MODELS
model AuditLog {
  id                   String   @id @default(cuid())
  action               String // Action performed (USER_CREATED, CALL_STARTED, etc.)
  entityType           String // Type of entity affected (User, Contact, Campaign, etc.)
  entityId             String? // ID of the affected entity
  performedByUserId    String // ID of user performing the action
  performedByUserEmail String // Email of user performing the action
  performedByUserName  String // Name of user performing the action
  ipAddress            String? // IP address of the request
  userAgent            String? // Browser/client user agent
  sessionId            String? // Session identifier
  previousValues       String? // JSON of previous state
  newValues            String? // JSON of new state
  metadata             String? // Additional JSON metadata
  severity             String   @default("INFO") // INFO, WARNING, ERROR, CRITICAL
  timestamp            DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([performedByUserId])
  @@index([timestamp])
  @@index([severity])
  @@map("audit_logs")
}

// EMAIL VERIFICATION MODEL
model EmailVerification {
  id         String    @id @default(cuid())
  userId     Int // Foreign key to User model
  email      String // Email being verified
  token      String // Verification token (plaintext for email)
  tokenHash  String // Hashed version for database lookup
  expiresAt  DateTime // Token expiration time
  verifiedAt DateTime? // When verification was completed
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tokenHash])
  @@index([userId])
  @@index([email])
  @@index([expiresAt])
  @@map("email_verifications")
}

// MULTI-TENANT FLOW MANAGEMENT MODELS

model FlowTemplate {
  id              String        @id @default(cuid())
  name            String
  description     String
  category        String?       // Category for organization (e.g., "Lead Generation", "Support")
  tags            String?       // JSON array of tags for filtering
  organizationId  String
  createdByUserId Int
  isPublic        Boolean       @default(false) // Whether this template can be shared across orgs
  usageCount      Int           @default(0) // How many times this template has been used
  rating          Float?        // Average rating from users
  templateData    String        // JSON string with flow structure
  previewImage    String?       // URL to preview image
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User          @relation("FlowTemplateCreator", fields: [createdByUserId], references: [id])

  @@index([organizationId])
  @@index([category])
  @@index([isPublic])
  @@map("flow_templates")
}

model FlowPermission {
  id              String        @id @default(cuid())
  flowId          String
  userId          Int
  permissionType  String        // VIEW, EDIT, EXECUTE, ADMIN
  grantedByUserId Int
  grantedAt       DateTime      @default(now())
  expiresAt       DateTime?
  
  flow            Flow          @relation(fields: [flowId], references: [id], onDelete: Cascade)
  user            User          @relation("FlowPermissionUser", fields: [userId], references: [id], onDelete: Cascade)
  grantedBy       User          @relation("FlowPermissionGranter", fields: [grantedByUserId], references: [id])

  @@unique([flowId, userId, permissionType])
  @@index([flowId])
  @@index([userId])
  @@map("flow_permissions")
}

model FlowShare {
  id                String        @id @default(cuid())
  flowId            String
  sharedWithOrgId   String
  sharedByUserId    Int
  accessType        String        // VIEW_ONLY, COPY_ALLOWED, COLLABORATIVE
  permissions       String?       // JSON string with specific permissions
  sharedAt          DateTime      @default(now())
  expiresAt         DateTime?
  isActive          Boolean       @default(true)
  
  flow              Flow          @relation(fields: [flowId], references: [id], onDelete: Cascade)
  sharedWithOrg     Organization  @relation("FlowSharedWithOrg", fields: [sharedWithOrgId], references: [id], onDelete: Cascade)
  sharedBy          User          @relation("FlowSharedBy", fields: [sharedByUserId], references: [id])

  @@unique([flowId, sharedWithOrgId])
  @@index([flowId])
  @@index([sharedWithOrgId])
  @@index([sharedByUserId])
  @@map("flow_shares")
}

model OrganizationAnalytics {
  id                    String        @id @default(cuid())
  organizationId        String
  period                String        // DAILY, WEEKLY, MONTHLY
  periodStart           DateTime
  periodEnd             DateTime
  
  // Flow usage metrics
  totalFlows            Int           @default(0)
  activeFlows           Int           @default(0)
  totalExecutions       Int           @default(0)
  successfulExecutions  Int           @default(0)
  failedExecutions      Int           @default(0)
  
  // Performance metrics
  avgExecutionTime      Float?
  avgSuccessRate        Float?
  totalResourceUsage    Float?
  
  // User engagement metrics
  activeUsers           Int           @default(0)
  newFlowsCreated       Int           @default(0)
  templatesUsed         Int           @default(0)
  
  createdAt             DateTime      @default(now())
  
  organization          Organization  @relation("OrganizationAnalytics", fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, period, periodStart])
  @@index([organizationId])
  @@index([period])
  @@index([periodStart])
  @@map("organization_analytics")
}

// SENTIMENT ANALYSIS & AI MODELS

model CallAnalysis {
  id                        String   @id @default(cuid())
  callId                    String   @unique
  agentId                   String?
  
  // Sentiment Analysis Results
  sentimentScore            Float    // -1 to 1 scale
  sentiment                 String   // POSITIVE, NEUTRAL, NEGATIVE
  confidence                Float    // 0 to 1 confidence score
  emotions                  String?  // JSON string of emotion scores
  urgency                   String?  // LOW, MEDIUM, HIGH
  keywords                  String?  // JSON array of detected keywords
  
  // Call Quality Metrics
  qualityScore              Int?     // 1-10 quality rating
  currentMood               String?  // ESCALATING, IMPROVING, STABLE
  riskLevel                 String?  // LOW, MEDIUM, HIGH, CRITICAL
  
  // AI Recommendations
  coachingRecommendations   String?  // JSON array of coaching suggestions
  nextBestActions           String?  // JSON array of next best actions
  complianceFlags           String?  // JSON array of compliance issues
  
  // Metadata
  analyzedAt                DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  // Relations
  call                      CallRecord? @relation(fields: [callId], references: [callId])
  agent                     Agent?      @relation(fields: [agentId], references: [id])

  @@index([callId])
  @@index([agentId])
  @@index([sentiment])
  @@index([riskLevel])
  @@index([analyzedAt])
  @@map("call_analysis")
}

model Alert {
  id          String   @id @default(cuid())
  type        String   // CALL_QUALITY_CRITICAL, COMPLIANCE_VIOLATION, etc.
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  title       String
  message     String
  
  // Context
  callId      String?
  agentId     String?
  campaignId  String?
  
  // Metadata
  metadata    String?  // JSON string with additional context
  acknowledged Boolean  @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  call        CallRecord? @relation(fields: [callId], references: [callId])
  agent       Agent?      @relation(fields: [agentId], references: [id])
  campaign    Campaign?   @relation(fields: [campaignId], references: [campaignId])

  @@index([type])
  @@index([severity])
  @@index([callId])
  @@index([agentId])
  @@index([acknowledged])
  @@index([createdAt])
  @@map("alerts")
}

model QualityMonitoring {
  id                    String   @id @default(cuid())
  callId                String
  agentId               String
  monitoredBy           String?  // Supervisor ID
  
  // Quality Scores (1-10 scale)
  overallQuality        Int
  communicationSkills   Int?
  productKnowledge      Int?
  processAdherence      Int?
  customerSatisfaction  Int?
  complianceScore       Int?
  
  // Detailed Analysis
  strengths             String?  // JSON array of identified strengths
  improvementAreas      String?  // JSON array of improvement areas
  coachingNotes         String?  // Supervisor coaching notes
  
  // Automated Analysis
  scriptAdherence       Float?   // 0-1 score for script following
  sentimentProgression  String?  // JSON timeline of sentiment changes
  complianceViolations  String?  // JSON array of compliance issues
  
  // Action Items
  followUpRequired      Boolean  @default(false)
  coachingScheduled     Boolean  @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  call                  CallRecord @relation(fields: [callId], references: [callId])
  agent                 Agent      @relation(fields: [agentId], references: [id])

  @@unique([callId])
  @@index([agentId])
  @@index([overallQuality])
  @@index([monitoredBy])
  @@index([createdAt])
  @@map("quality_monitoring")
}

// Phase 3: AI Dialler Models

// Real-time Sentiment Analysis
model SentimentAnalysis {
  id                    String    @id @default(cuid())
  callId                String
  agentId               String
  timestamp             DateTime
  sentiment             String    // positive, negative, neutral
  confidence            Float
  transcript            String?   // Transcript excerpt for this analysis
  emotions              String?   // JSON of emotion scores {joy, anger, fear, etc}
  intent                String?   // Detected customer intent
  keywords              String?   // JSON array of detected keywords
  
  createdAt             DateTime  @default(now())
  
  // Relations
  callRecord            CallRecord @relation(fields: [callId], references: [callId])

  @@index([callId])
  @@index([agentId])
  @@index([timestamp])
  @@index([sentiment])
  @@map("sentiment_analysis")
}

// Coaching Suggestions
model CoachingSuggestion {
  id                    String    @id @default(cuid())
  callId                String
  agentId               String
  type                  String    // objection_handling, empathy, closing, product_knowledge, tone_adjustment
  message               String
  priority              String    // low, medium, high, urgent
  timestamp             DateTime
  acknowledged          Boolean   @default(false)
  acknowledgedAt        DateTime?
  
  createdAt             DateTime  @default(now())

  @@index([callId])
  @@index([agentId])
  @@index([priority])
  @@index([acknowledged])
  @@map("coaching_suggestions")
}

// Quality Scores
model QualityScore {
  id                    String    @id @default(cuid())
  callId                String    @unique
  agentId               String
  overallScore          Float
  communicationScore    Float
  empathyScore          Float
  complianceScore       Float
  effectivenessScore    Float
  
  createdAt             DateTime  @default(now())

  @@index([agentId])
  @@index([overallScore])
  @@map("quality_scores")
}

// Lead Scores  
model LeadScore {
  id                    String    @id @default(cuid())
  contactId             String    @unique
  score                 Float
  confidence            Float
  priority              String    // low, medium, high, urgent
  factors               String?   // JSON of scoring factors
  nextBestAction        String?
  estimatedRevenue      Float?
  conversionProbability Float?
  timeToContact         Int?      // Optimal hours to wait
  preferredChannel      String?   // voice, sms, email
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  contact               Contact   @relation(fields: [contactId], references: [contactId])

  @@index([contactId])
  @@index([score])
  @@index([priority])
  @@map("lead_scores")
}

// Compliance Alerts
model ComplianceAlert {
  id                    String    @id @default(cuid())
  callId                String
  agentId               String
  alertType             String    // regulatory, company_policy, script_deviation
  severity              String    // low, medium, high, critical
  description           String
  context               String?
  suggestion            String?
  requiresAction        Boolean   @default(false)
  resolvedAt            DateTime?
  resolvedBy            String?
  
  createdAt             DateTime  @default(now())

  @@index([callId])
  @@index([agentId])
  @@index([severity])
  @@index([requiresAction])
  @@map("compliance_alerts")
}

// AI Recommendation Tracking
model AiRecommendation {
  id                    String    @id @default(cuid())
  callId                String
  agentId               String
  type                  String    // DISPOSITION, NEXT_ACTION, COACHING
  recommendation        String    // JSON of recommendation data
  confidence            Float
  status                String    @default("PENDING") // PENDING, ACCEPTED, OVERRIDDEN, IGNORED
  appliedAt             DateTime?
  appliedBy             String?
  feedbackReceived      Boolean   @default(false)
  feedbackScore         Float?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  callRecord            CallRecord @relation(fields: [callId], references: [callId])
  feedback              AiFeedback[]

  @@index([callId])
  @@index([agentId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("ai_recommendations")
}

// AI Feedback for Accuracy Tracking
model AiFeedback {
  id                    String    @id @default(cuid())
  recommendationId      String
  agentId               String
  correct               Boolean
  actualOutcome         String?
  feedback              String?
  
  createdAt             DateTime  @default(now())
  
  // Relations
  recommendation        AiRecommendation @relation(fields: [recommendationId], references: [id])

  @@index([recommendationId])
  @@index([agentId])
  @@index([correct])
  @@index([createdAt])
  @@map("ai_feedback")
}

// Disposition Tracking for Analytics
model DispositionTracking {
  id                    String    @id @default(cuid())
  callId                String
  dispositionId         String
  agentId               String
  timestamp             DateTime
  method                String    // AGENT_MANUAL, AI_ASSISTED, AI_AUTO
  confidence            Float?
  notes                 String?
  
  createdAt             DateTime  @default(now())
  
  // Relations
  callRecord            CallRecord @relation(fields: [callId], references: [callId])
  disposition           Disposition @relation(fields: [dispositionId], references: [id])

  @@index([callId])
  @@index([dispositionId])
  @@index([agentId])
  @@index([timestamp])
  @@index([method])
  @@map("disposition_tracking")
}

// Automation Triggers for Next-Best-Actions
model AutomationTrigger {
  id                    String    @id @default(cuid())
  callId                String
  triggerType           String    // SCHEDULE, CAMPAIGN, SUPPRESSION, ESCALATION
  triggerData           String    // JSON configuration
  status                String    @default("PENDING") // PENDING, COMPLETED, FAILED
  scheduledFor          DateTime
  executedAt            DateTime?
  createdBy             String
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  // Relations
  callRecord            CallRecord @relation(fields: [callId], references: [callId])

  @@index([callId])
  @@index([triggerType])
  @@index([status])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("automation_triggers")
}
