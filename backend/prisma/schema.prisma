generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model DataList {
  id            String           @id @default(cuid())
  listId        String           @unique
  name          String
  campaignId    String?
  active        Boolean          @default(false)
  blendWeight   Int?
  totalContacts Int              @default(0)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  contacts      Contact[]
  queueEntries  DialQueueEntry[]

  @@map("data_lists")
}

model Contact {
  id                String           @id @default(cuid())
  contactId         String           @unique
  listId            String
  firstName         String
  lastName          String
  fullName          String?
  title             String?
  phone             String
  mobile            String?
  workPhone         String?
  homePhone         String?
  email             String?
  company           String?
  jobTitle          String?
  department        String?
  industry          String?
  address           String?
  address2          String?
  address3          String?
  city              String?
  state             String?
  zipCode           String?
  country           String?
  website           String?
  linkedIn          String?
  notes             String?
  tags              String?
  leadSource        String?
  deliveryDate      DateTime?
  ageRange          String?
  residentialStatus String?
  custom1           String?
  custom2           String?
  custom3           String?
  custom4           String?
  custom5           String?
  status            String           @default("new")
  attemptCount      Int              @default(0)
  maxAttempts       Int              @default(3)
  lastAgentId       String?
  lastOutcome       String?
  locked            Boolean          @default(false)
  lockedBy          String?
  lockedAt          DateTime?
  lastAttempt       DateTime?
  nextAttempt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  callKPIs          CallKPI[]
  callRecords       CallRecord[]
  list              DataList         @relation(fields: [listId], references: [listId], onDelete: Cascade)
  queueEntries      DialQueueEntry[]
  inbound_calls     inbound_calls[]
  interactions      Interaction[]
  lead_scores       lead_scores?
  sales             Sale[]
  tasks             Task[]
  workItems         WorkItem[]

  @@map("contacts")
}

model DialQueueEntry {
  id              String    @id @default(cuid())
  queueId         String    @unique
  campaignId      String
  listId          String
  contactId       String
  status          String    @default("queued")
  assignedAgentId String?
  priority        Int       @default(100)
  queuedAt        DateTime  @default(now())
  dialedAt        DateTime?
  completedAt     DateTime?
  outcome         String?
  notes           String?
  contact         Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  list            DataList  @relation(fields: [listId], references: [listId], onDelete: Cascade)

  @@map("dial_queue")
}

model Campaign {
  id                   String                    @id @default(cuid())
  campaignId           String                    @unique
  name                 String
  dialMethod           String                    @default("Progressive")
  speed                Float                     @default(2.0)
  dropPercentage       Float                     @default(0.0)
  status               String                    @default("Inactive")
  description          String?
  maxLines             Int?
  dialRatio            Float?
  recordCalls          Boolean                   @default(false)
  allowTransfers       Boolean                   @default(false)
  campaignScript       String?
  fieldMapping         String?
  retrySettings        String?
  hoursOfOperation     String?
  abandonRateThreshold Float?                    @default(0.05)
  pacingMultiplier     Float?                    @default(1.0)
  maxCallsPerAgent     Int?                      @default(1)
  createdAt            DateTime                  @default(now())
  updatedAt            DateTime                  @updatedAt
  createdById          Int?
  isActive             Boolean                   @default(false)
  outboundNumber       String?
  agentAssignments     AgentCampaignAssignment[]
  alerts               alerts[]
  callKPIs             CallKPI[]
  callRecords          CallRecord[]
  campaignDispositions CampaignDisposition[]
  createdBy            User?                     @relation("CampaignCreator", fields: [createdById], references: [id])
  interactions         Interaction[]
  tasks                Task[]
  userAssignments      UserCampaignAssignment[]  @relation("CampaignUserAssignments")
  workItems            WorkItem[]

  @@map("campaigns")
}

model Agent {
  id                  String                    @id @default(cuid())
  agentId             String                    @unique
  firstName           String
  lastName            String
  email               String                    @unique
  status              String                    @default("Offline")
  lastStatusChange    DateTime                  @default(now())
  extension           String?
  skills              String?
  isLoggedIn          Boolean                   @default(false)
  currentCall         String?
  sipUsername         String?
  sipPassword         String?
  maxConcurrentCalls  Int                       @default(1)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt
  campaignAssignments AgentCampaignAssignment[]
  alerts              alerts[]
  call_analysis       call_analysis[]
  callKPIs            CallKPI[]
  callRecords         CallRecord[]
  inbound_calls       inbound_calls[]
  interactions        Interaction[]
  quality_monitoring  quality_monitoring[]
  sales               Sale[]
  tasks               Task[]
  workItems           WorkItem[]

  @@map("agents")
}

model AgentCampaignAssignment {
  id         String   @id @default(cuid())
  agentId    String
  campaignId String
  isActive   Boolean  @default(true)
  assignedAt DateTime @default(now())
  agent      Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  campaign   Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)

  @@unique([agentId, campaignId])
  @@map("agent_campaign_assignments")
}

model WorkItem {
  id          String    @id @default(cuid())
  workItemId  String    @unique
  agentId     String
  campaignId  String
  contactId   String
  callId      String?
  status      String    @default("active")
  contactData String?
  scriptData  String?
  startTime   DateTime  @default(now())
  endTime     DateTime?
  agent       Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  campaign    Campaign  @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact     Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)

  @@map("work_items")
}

model Disposition {
  id                   String                 @id @default(cuid())
  name                 String
  description          String?
  category             String?
  isActive             Boolean                @default(true)
  retryEligible        Boolean                @default(false)
  retryDelay           Int?
  createdAt            DateTime               @default(now())
  callRecords          CallRecord[]
  campaignDispositions CampaignDisposition[]
  disposition_tracking disposition_tracking[]

  @@map("dispositions")
}

model CampaignDisposition {
  id            String      @id @default(cuid())
  campaignId    String
  dispositionId String
  isRequired    Boolean     @default(false)
  sortOrder     Int         @default(0)
  campaign      Campaign    @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  disposition   Disposition @relation(fields: [dispositionId], references: [id], onDelete: Cascade)

  @@unique([campaignId, dispositionId])
  @@map("campaign_dispositions")
}

model CallKPI {
  id                  String   @id @default(cuid())
  campaignId          String
  agentId             String
  contactId           String
  callId              String   @unique
  disposition         String
  dispositionCategory String
  callDuration        Int
  callDate            DateTime
  hourOfDay           Int
  dayOfWeek           Int
  listId              String?
  outcome             String
  notes               String?
  createdAt           DateTime @default(now())
  agent               Agent    @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  campaign            Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact             Contact  @relation(fields: [contactId], references: [contactId], onDelete: Cascade)

  @@map("call_kpis")
}

model CallRecord {
  id                   String                 @id @default(cuid())
  callId               String                 @unique
  campaignId           String
  contactId            String
  agentId              String?
  phoneNumber          String
  dialedNumber         String?
  callType             String                 @default("outbound")
  startTime            DateTime
  endTime              DateTime?
  duration             Int?
  outcome              String?
  dispositionId        String?
  notes                String?
  recording            String?
  transferTo           String?
  createdAt            DateTime               @default(now())
  ai_recommendations   ai_recommendations[]
  alerts               alerts[]
  automation_triggers  automation_triggers[]
  call_analysis        call_analysis?
  agent                Agent?                 @relation(fields: [agentId], references: [agentId])
  campaign             Campaign               @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact              Contact                @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  disposition          Disposition?           @relation(fields: [dispositionId], references: [id])
  disposition_tracking disposition_tracking[]
  quality_monitoring   quality_monitoring?
  recordingFile        Recording?
  sentiment_analysis   sentiment_analysis[]

  @@map("call_records")
}

model Interaction {
  id              String    @id @default(cuid())
  agentId         String
  contactId       String
  campaignId      String
  channel         String    @default("voice")
  outcome         String
  isDmc           Boolean   @default(false)
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  result          String?
  agent           Agent     @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  campaign        Campaign  @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact         Contact   @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  sales           Sale[]

  @@map("interactions")
}

model Sale {
  id            String      @id @default(cuid())
  interactionId String
  contactId     String
  agentId       String
  amount        Float
  status        String      @default("success")
  createdAt     DateTime    @default(now())
  agent         Agent       @relation(fields: [agentId], references: [agentId], onDelete: Cascade)
  contact       Contact     @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  interaction   Interaction @relation(fields: [interactionId], references: [id], onDelete: Cascade)

  @@map("sales")
}

model Task {
  id             String   @id @default(cuid())
  assignedUserId String
  contactId      String
  campaignId     String
  type           String   @default("callback")
  notes          String?
  dueAt          DateTime
  status         String   @default("open")
  createdAt      DateTime @default(now())
  assignedUser   Agent    @relation(fields: [assignedUserId], references: [agentId], onDelete: Cascade)
  campaign       Campaign @relation(fields: [campaignId], references: [campaignId], onDelete: Cascade)
  contact        Contact  @relation(fields: [contactId], references: [contactId], onDelete: Cascade)

  @@map("tasks")
}

model User {
  id                                                       Int                      @id @default(autoincrement())
  username                                                 String                   @unique
  email                                                    String                   @unique
  password                                                 String
  firstName                                                String
  lastName                                                 String
  name                                                     String
  role                                                     String                   @default("AGENT")
  isActive                                                 Boolean                  @default(true)
  lastLogin                                                DateTime?
  lastLoginAttempt                                         DateTime?
  failedLoginAttempts                                      Int                      @default(0)
  accountLockedUntil                                       DateTime?
  passwordResetToken                                       String?
  passwordResetExpires                                     DateTime?
  twoFactorSecret                                          String?
  twoFactorEnabled                                         Boolean                  @default(false)
  refreshTokenVersion                                      Int                      @default(0)
  preferences                                              String?
  status                                                   String                   @default("away")
  statusSince                                              DateTime                 @default(now())
  createdAt                                                DateTime                 @default(now())
  updatedAt                                                DateTime                 @updatedAt
  createdCampaigns                                         Campaign[]               @relation("CampaignCreator")
  channelActivities                                        ChannelActivity[]        @relation("ChannelActivityUser")
  assignedChannels                                         ChannelAssignment[]      @relation("ChannelAssigner")
  channelAssignments                                       ChannelAssignment[]      @relation("ChannelUserAssignment")
  channelConfigurations                                    ChannelConfiguration[]   @relation("ChannelConfigCreator")
  channelSchedules                                         ChannelSchedule[]        @relation("ChannelScheduleCreator")
  createdChannels                                          Channel[]                @relation("ChannelCreator")
  updatedChannels                                          Channel[]                @relation("ChannelUpdater")
  emailVerifications                                       EmailVerification[]
  flow_permissions_flow_permissions_grantedByUserIdTousers flow_permissions[]       @relation("flow_permissions_grantedByUserIdTousers")
  flow_permissions_flow_permissions_userIdTousers          flow_permissions[]       @relation("flow_permissions_userIdTousers")
  flow_shares                                              flow_shares[]
  flow_templates                                           flow_templates[]
  flow_version_rollbacks                                   flow_version_rollbacks[]
  flow_versions                                            FlowVersion[]
  flows                                                    Flow[]
  integrations                                             Integration[]            @relation("UserIntegrations")
  notifications                                            Notification[]           @relation("UserNotifications")
  refreshTokens                                            RefreshToken[]
  acknowledgedAlerts                                       SystemAlert[]            @relation("AlertAcknowledger")
  resolvedAlerts                                           SystemAlert[]            @relation("AlertResolver")
  assignedCampaigns                                        UserCampaignAssignment[] @relation("CampaignAssigner")
  campaignAssignments                                      UserCampaignAssignment[] @relation("UserCampaignAssignments")
  sessions                                                 UserSession[]            @relation("UserSessions")
  webhooks                                                 Webhook[]                @relation("UserWebhooks")

  @@map("users")
}

model UserCampaignAssignment {
  id             String   @id @default(cuid())
  userId         Int
  campaignId     String
  isActive       Boolean  @default(true)
  assignedAt     DateTime @default(now())
  assignedBy     Int?
  assignedByUser User?    @relation("CampaignAssigner", fields: [assignedBy], references: [id])
  campaign       Campaign @relation("CampaignUserAssignments", fields: [campaignId], references: [campaignId], onDelete: Cascade)
  user           User     @relation("UserCampaignAssignments", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, campaignId])
  @@map("user_campaign_assignments")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime  @default(now())
  lastUsed  DateTime?
  isRevoked Boolean   @default(false)
  userAgent String?
  ipAddress String?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Flow {
  id               String             @id @default(cuid())
  name             String
  description      String
  status           String             @default("INACTIVE")
  createdByUserId  Int
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  isTemplate       Boolean            @default(false)
  organizationId   String?
  templateSource   String?
  visibility       String             @default("PRIVATE")
  flow_permissions flow_permissions[]
  flow_shares      flow_shares[]
  versions         FlowVersion[]
  createdBy        User               @relation(fields: [createdByUserId], references: [id])
  organizations    Organization?      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inbound_numbers  InboundNumber[]

  @@index([organizationId])
  @@index([organizationId, visibility])
  @@map("flows")
}

model FlowVersion {
  id                                                                         String                   @id @default(cuid())
  flowId                                                                     String
  versionNumber                                                              Int
  isActive                                                                   Boolean                  @default(false)
  isDraft                                                                    Boolean                  @default(true)
  createdAt                                                                  DateTime                 @default(now())
  publishedAt                                                                DateTime?
  approvedAt                                                                 DateTime?
  approvedBy                                                                 Int?
  archivedAt                                                                 DateTime?
  changeLog                                                                  String?
  performance                                                                String?
  rollbackReason                                                             String?
  edges                                                                      FlowEdge[]
  nodes                                                                      FlowNode[]
  runs                                                                       FlowRun[]
  flow_version_rollbacks_flow_version_rollbacks_fromVersionIdToflow_versions flow_version_rollbacks[] @relation("flow_version_rollbacks_fromVersionIdToflow_versions")
  flow_version_rollbacks_flow_version_rollbacks_toVersionIdToflow_versions   flow_version_rollbacks[] @relation("flow_version_rollbacks_toVersionIdToflow_versions")
  users                                                                      User?                    @relation(fields: [approvedBy], references: [id])
  flow                                                                       Flow                     @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@unique([flowId, versionNumber])
  @@map("flow_versions")
}

model FlowNode {
  id            String      @id @default(cuid())
  flowVersionId String
  type          String
  label         String
  category      String
  x             Float
  y             Float
  config        String
  isEntry       Boolean     @default(false)
  sourceEdges   FlowEdge[]  @relation("SourceNode")
  targetEdges   FlowEdge[]  @relation("TargetNode")
  flowVersion   FlowVersion @relation(fields: [flowVersionId], references: [id], onDelete: Cascade)

  @@map("flow_nodes")
}

model FlowEdge {
  id            String      @id @default(cuid())
  flowVersionId String
  sourceNodeId  String
  targetNodeId  String
  sourcePort    String
  label         String?
  flowVersion   FlowVersion @relation(fields: [flowVersionId], references: [id], onDelete: Cascade)
  sourceNode    FlowNode    @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode    FlowNode    @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  @@map("flow_edges")
}

model NodeTypeDefinition {
  id          String  @id @default(cuid())
  type        String  @unique
  category    String
  displayName String
  icon        String?
  schema      String
  ports       String

  @@map("node_type_definitions")
}

model FlowRun {
  id                String        @id @default(cuid())
  flowVersionId     String
  externalReference String?
  status            String        @default("RUNNING")
  startedAt         DateTime      @default(now())
  finishedAt        DateTime?
  context           String
  steps             FlowRunStep[]
  flowVersion       FlowVersion   @relation(fields: [flowVersionId], references: [id])

  @@map("flow_runs")
}

model FlowRunStep {
  id         String    @id @default(cuid())
  flowRunId  String
  nodeId     String
  status     String    @default("PENDING")
  startedAt  DateTime  @default(now())
  finishedAt DateTime?
  output     String?
  flowRun    FlowRun   @relation(fields: [flowRunId], references: [id], onDelete: Cascade)

  @@map("flow_run_steps")
}

model Organization {
  id                     String                   @id @default(cuid())
  name                   String                   @unique
  displayName            String
  description            String?
  website                String?
  industry               String?
  size                   String?
  timezone               String                   @default("UTC")
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  channels               Channel[]
  flow_shares            flow_shares[]
  flow_templates         flow_templates[]
  flows                  Flow[]
  organization_analytics organization_analytics[]

  @@map("organizations")
}

model Team {
  id                 String              @id @default(cuid())
  name               String              @unique
  displayName        String
  description        String?
  department         String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  channelAssignments ChannelAssignment[] @relation("ChannelTeamAssignment")

  @@map("teams")
}

model Role {
  id                 String              @id @default(cuid())
  name               String              @unique
  displayName        String
  description        String?
  permissions        String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  channelAssignments ChannelAssignment[] @relation("ChannelRoleAssignment")

  @@map("roles")
}

model Channel {
  id                 String                 @id @default(cuid())
  name               String                 @unique
  displayName        String
  description        String?
  type               String
  status             String                 @default("ACTIVE")
  priority           Int                    @default(1)
  isInbound          Boolean                @default(true)
  isOutbound         Boolean                @default(true)
  isBlended          Boolean                @default(false)
  maxConcurrentCalls Int                    @default(100)
  maxQueueSize       Int                    @default(1000)
  maxWaitTime        Int                    @default(300)
  predictiveMode     Boolean                @default(false)
  progressiveMode    Boolean                @default(true)
  previewMode        Boolean                @default(false)
  manualMode         Boolean                @default(false)
  dialingRatio       Float                  @default(1.0)
  abandonThreshold   Float                  @default(0.05)
  pacingMultiplier   Float                  @default(1.0)
  timezone           String                 @default("UTC")
  dialingStart       String?
  dialingEnd         String?
  dncCompliance      Boolean                @default(true)
  tcpaCompliance     Boolean                @default(true)
  gdprCompliance     Boolean                @default(true)
  callRecording      Boolean                @default(true)
  qualityMonitoring  Boolean                @default(true)
  screenRecording    Boolean                @default(false)
  slaAnswerTime      Int?
  slaResolutionTime  Int?
  slaEscalationTime  Int?
  tags               String?
  customFields       String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  createdBy          Int?
  updatedBy          Int?
  organizationId     String
  activities         ChannelActivity[]
  assignments        ChannelAssignment[]
  capacities         ChannelCapacity[]
  configurations     ChannelConfiguration[]
  metrics            ChannelMetrics[]
  routes             ChannelRoute[]
  schedules          ChannelSchedule[]
  creator            User?                  @relation("ChannelCreator", fields: [createdBy], references: [id])
  organization       Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  updater            User?                  @relation("ChannelUpdater", fields: [updatedBy], references: [id])

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("channels")
}

model ChannelRoute {
  id              String   @id @default(cuid())
  name            String
  displayName     String
  description     String?
  routeType       String
  priority        Int      @default(1)
  isActive        Boolean  @default(true)
  conditions      String
  actions         String
  fallbackRoute   String?
  loadBalancing   String   @default("ROUND_ROBIN")
  weightingFactor Float    @default(1.0)
  maxConcurrent   Int      @default(10)
  timeoutSeconds  Int      @default(30)
  retryAttempts   Int      @default(3)
  businessHours   String?
  holidaySchedule String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  channelId       String
  channel         Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([routeType])
  @@index([priority])
  @@index([isActive])
  @@map("channel_routes")
}

model ChannelConfiguration {
  id          String   @id @default(cuid())
  configType  String
  name        String
  description String?
  settings    String
  parameters  String?
  validation  String?
  version     String   @default("1.0.0")
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  environment String   @default("PRODUCTION")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   Int?
  channelId   String
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  creator     User?    @relation("ChannelConfigCreator", fields: [createdBy], references: [id])

  @@unique([channelId, configType, name])
  @@index([channelId])
  @@index([configType])
  @@index([environment])
  @@map("channel_configurations")
}

model ChannelSchedule {
  id            String    @id @default(cuid())
  name          String
  description   String?
  scheduleType  String
  timezone      String    @default("UTC")
  startTime     String
  endTime       String
  daysOfWeek    String
  dates         String?
  exceptions    String?
  maxConcurrent Int?
  maxQueue      Int?
  dialingRatio  Float?
  isActive      Boolean   @default(true)
  priority      Int       @default(1)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     Int?
  channelId     String
  channel       Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  creator       User?     @relation("ChannelScheduleCreator", fields: [createdBy], references: [id])

  @@index([channelId])
  @@index([scheduleType])
  @@index([effectiveFrom])
  @@index([effectiveTo])
  @@map("channel_schedules")
}

model ChannelCapacity {
  id                   String   @id @default(cuid())
  capacityType         String
  maxConcurrent        Int
  currentUtilization   Int      @default(0)
  peakUtilization      Int      @default(0)
  averageUtilization   Float    @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  droppedCalls         Int      @default(0)
  abandonedCalls       Int      @default(0)
  averageWaitTime      Float    @default(0)
  averageHandleTime    Float    @default(0)
  averageHoldTime      Float    @default(0)
  firstCallResolution  Float    @default(0)
  customerSatisfaction Float    @default(0)
  agentUtilization     Float    @default(0)
  periodStart          DateTime
  periodEnd            DateTime
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  channelId            String
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([capacityType])
  @@index([periodStart])
  @@index([periodEnd])
  @@map("channel_capacities")
}

model ChannelAssignment {
  id                   String   @id @default(cuid())
  assignmentType       String
  priority             Int      @default(1)
  isActive             Boolean  @default(true)
  maxConcurrent        Int?
  skillRequirement     String?
  scheduleOverride     String?
  availabilityWindow   String?
  minimumExperience    Int?
  performanceThreshold Float?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  assignedAt           DateTime @default(now())
  assignedBy           Int?
  channelId            String
  userId               Int?
  teamId               String?
  roleId               String?
  assigner             User?    @relation("ChannelAssigner", fields: [assignedBy], references: [id])
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  role                 Role?    @relation("ChannelRoleAssignment", fields: [roleId], references: [id], onDelete: Cascade)
  team                 Team?    @relation("ChannelTeamAssignment", fields: [teamId], references: [id], onDelete: Cascade)
  user                 User?    @relation("ChannelUserAssignment", fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([assignmentType])
  @@index([userId])
  @@index([teamId])
  @@index([roleId])
  @@index([assignedAt])
  @@map("channel_assignments")
}

model ChannelMetrics {
  id                   String   @id @default(cuid())
  metricType           String
  totalCalls           Int      @default(0)
  successfulCalls      Int      @default(0)
  failedCalls          Int      @default(0)
  droppedCalls         Int      @default(0)
  abandonedCalls       Int      @default(0)
  inboundCalls         Int      @default(0)
  outboundCalls        Int      @default(0)
  peakConcurrent       Int      @default(0)
  averageConcurrent    Float    @default(0)
  totalCallDuration    Int      @default(0)
  averageCallDuration  Float    @default(0)
  totalWaitTime        Int      @default(0)
  averageWaitTime      Float    @default(0)
  totalHandleTime      Int      @default(0)
  averageHandleTime    Float    @default(0)
  serviceLevel         Float    @default(0)
  abandonRate          Float    @default(0)
  firstCallResolution  Float    @default(0)
  transferRate         Float    @default(0)
  agentUtilization     Float    @default(0)
  channelUtilization   Float    @default(0)
  costPerCall          Float    @default(0)
  revenuePerCall       Float    @default(0)
  customerSatisfaction Float    @default(0)
  netPromoterScore     Float    @default(0)
  complaintsReceived   Int      @default(0)
  complimentsReceived  Int      @default(0)
  periodType           String
  periodStart          DateTime
  periodEnd            DateTime
  calculatedAt         DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  channelId            String
  channel              Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@index([metricType])
  @@index([periodType])
  @@index([periodStart])
  @@index([periodEnd])
  @@index([calculatedAt])
  @@map("channel_metrics")
}

model ChannelActivity {
  id            String   @id @default(cuid())
  activityType  String
  description   String
  details       String?
  oldValues     String?
  newValues     String?
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  impactLevel   String   @default("LOW")
  affectedUsers Int      @default(0)
  timestamp     DateTime @default(now())
  channelId     String
  userId        Int?
  channel       Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user          User?    @relation("ChannelActivityUser", fields: [userId], references: [id])

  @@index([channelId])
  @@index([activityType])
  @@index([timestamp])
  @@index([userId])
  @@index([impactLevel])
  @@map("channel_activities")
}

model Integration {
  id            String           @id @default(cuid())
  name          String
  type          String
  description   String?
  provider      String
  isActive      Boolean          @default(true)
  configuration String
  credentials   String?
  lastSync      DateTime?
  syncStatus    String           @default("inactive")
  errorMessage  String?
  createdBy     Int
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  syncLogs      IntegrationLog[]
  creator       User             @relation("UserIntegrations", fields: [createdBy], references: [id])
  webhooks      Webhook[]

  @@map("integrations")
}

model IntegrationLog {
  id               String      @id @default(cuid())
  integrationId    String
  action           String
  status           String
  message          String
  details          String?
  recordsProcessed Int?
  errorCount       Int?
  duration         Int?
  timestamp        DateTime    @default(now())
  integration      Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([timestamp])
  @@index([status])
  @@map("integration_logs")
}

model Webhook {
  id            String            @id @default(cuid())
  name          String
  url           String
  secret        String?
  events        String
  isActive      Boolean           @default(true)
  integrationId String?
  retryPolicy   String?
  headers       String?
  createdBy     Int
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deliveries    WebhookDelivery[]
  creator       User              @relation("UserWebhooks", fields: [createdBy], references: [id])
  integration   Integration?      @relation(fields: [integrationId], references: [id])

  @@map("webhooks")
}

model WebhookDelivery {
  id           String    @id @default(cuid())
  webhookId    String
  eventType    String
  payload      String
  status       String
  responseCode Int?
  responseBody String?
  attemptCount Int       @default(0)
  maxAttempts  Int       @default(3)
  nextRetry    DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime  @default(now())
  webhook      Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetry])
  @@map("webhook_deliveries")
}

model Recording {
  id             String         @id @default(cuid())
  callRecordId   String         @unique
  fileName       String
  filePath       String
  fileSize       Int?
  duration       Int?
  format         String         @default("wav")
  quality        String         @default("standard")
  storageType    String         @default("local")
  isEncrypted    Boolean        @default(false)
  uploadStatus   String         @default("pending")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  callRecord     CallRecord     @relation(fields: [callRecordId], references: [id], onDelete: Cascade)
  transcriptions Transcription?

  @@index([uploadStatus])
  @@map("recordings")
}

model Transcription {
  id             String    @id @default(cuid())
  recordingId    String    @unique
  provider       String
  language       String    @default("en")
  text           String
  segments       String?
  confidence     Float?
  wordCount      Int?
  processingTime Int?
  cost           Float?
  status         String    @default("pending")
  errorMessage   String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  recording      Recording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([language])
  @@map("transcriptions")
}

model Notification {
  id          String    @id @default(cuid())
  userId      Int
  title       String
  message     String
  type        String    @default("info")
  category    String?
  priority    String    @default("normal")
  isRead      Boolean   @default(false)
  actionUrl   String?
  actionLabel String?
  metadata    String?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([type])
  @@index([priority])
  @@index([createdAt])
  @@map("notifications")
}

model SystemAlert {
  id             String    @id @default(cuid())
  title          String
  message        String
  alertType      String
  severity       String
  status         String    @default("active")
  source         String?
  metadata       String?
  acknowledgedBy Int?
  acknowledgedAt DateTime?
  resolvedBy     Int?
  resolvedAt     DateTime?
  createdAt      DateTime  @default(now())
  acknowledger   User?     @relation("AlertAcknowledger", fields: [acknowledgedBy], references: [id])
  resolver       User?     @relation("AlertResolver", fields: [resolvedBy], references: [id])

  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@map("system_alerts")
}

model InboundNumber {
  id                       String        @id @default(cuid())
  phoneNumber              String        @unique
  displayName              String
  country                  String
  region                   String?
  numberType               String        @default("LOCAL")
  provider                 String        @default("TWILIO")
  isActive                 Boolean       @default(true)
  capabilities             String?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  assignedFlowId           String?
  assignedToDefaultList    Boolean?      @default(true)
  autoRejectAnonymous      Boolean?      @default(true)
  businessDays             String?       @default("Monday,Tuesday,Wednesday,Thursday,Friday")
  businessHours            String?       @default("24 Hours")
  businessHoursEnd         String?       @default("17:00")
  businessHoursStart       String?       @default("09:00")
  busyAudioUrl             String?
  countryCode              String?       @default("United Kingdom Of Great Britain And Northern Ireland (The) (GB)")
  createContactOnAnonymous Boolean?      @default(true)
  description              String?
  greetingAudioUrl         String?
  integration              String?       @default("None")
  lookupSearchFilter       String?       @default("All Lists")
  noAnswerAudioUrl         String?
  outOfHoursAction         String?       @default("Hangup")
  outOfHoursAudioUrl       String?
  outOfHoursTransferNumber String?
  recordCalls              Boolean?      @default(true)
  routeTo                  String?       @default("Hangup")
  routeToQueueId           String?
  selectedExtension        String?
  selectedFlowId           String?
  selectedQueueId          String?
  selectedRingGroupId      String?
  timezone                 String?       @default("Europe/London")
  voicemailAudioUrl        String?
  flows                    Flow?         @relation(fields: [assignedFlowId], references: [id])
  inbound_queues           InboundQueue? @relation(fields: [routeToQueueId], references: [id])

  @@map("inbound_numbers")
}

model InboundQueue {
  id                    String          @id @default(cuid())
  name                  String          @unique
  displayName           String
  description           String?
  isActive              Boolean         @default(true)
  assignedAgents        String?
  businessHoursEnabled  Boolean         @default(true)
  businessHoursStart    String?         @default("09:00")
  businessHoursEnd      String?         @default("17:00")
  businessDays          String?         @default("Monday,Tuesday,Wednesday,Thursday,Friday")
  timezone              String?         @default("Europe/London")
  maxQueueSize          Int?            @default(50)
  overflowAction        String          @default("voicemail")
  overflowDestination   String?
  outOfHoursAction      String          @default("voicemail")
  outOfHoursDestination String?
  holdMusicUrl          String?
  welcomeMessageUrl     String?
  estimatedWaitUrl      String?
  ringStrategy          String          @default("round_robin")
  callTimeout           Int             @default(30)
  maxWaitTime           Int             @default(300)
  priority              Int             @default(1)
  skillTags             String?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  inbound_numbers       InboundNumber[]

  @@map("inbound_queues")
}

model AuditLog {
  id                   String   @id @default(cuid())
  action               String
  entityType           String
  entityId             String?
  performedByUserId    String
  performedByUserEmail String
  performedByUserName  String
  ipAddress            String?
  userAgent            String?
  sessionId            String?
  previousValues       String?
  newValues            String?
  metadata             String?
  severity             String   @default("INFO")
  timestamp            DateTime @default(now())

  @@index([action])
  @@index([entityType])
  @@index([performedByUserId])
  @@index([timestamp])
  @@index([severity])
  @@map("audit_logs")
}

model EmailVerification {
  id         String    @id @default(cuid())
  userId     Int
  email      String
  token      String
  tokenHash  String    @unique
  expiresAt  DateTime
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([expiresAt])
  @@map("email_verifications")
}

model ai_feedback {
  id                 String             @id
  recommendationId   String
  agentId            String
  correct            Boolean
  actualOutcome      String?
  feedback           String?
  createdAt          DateTime           @default(now())
  ai_recommendations ai_recommendations @relation(fields: [recommendationId], references: [id])

  @@index([agentId])
  @@index([correct])
  @@index([createdAt])
  @@index([recommendationId])
}

model ai_recommendations {
  id               String        @id
  callId           String
  agentId          String
  type             String
  recommendation   String
  confidence       Float
  status           String        @default("PENDING")
  appliedAt        DateTime?
  appliedBy        String?
  feedbackReceived Boolean       @default(false)
  feedbackScore    Float?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  ai_feedback      ai_feedback[]
  call_records     CallRecord    @relation(fields: [callId], references: [callId])

  @@index([agentId])
  @@index([callId])
  @@index([createdAt])
  @@index([status])
  @@index([type])
}

model alerts {
  id             String      @id
  type           String
  severity       String
  title          String
  message        String
  callId         String?
  agentId        String?
  campaignId     String?
  metadata       String?
  acknowledged   Boolean     @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime
  agents         Agent?      @relation(fields: [agentId], references: [id])
  call_records   CallRecord? @relation(fields: [callId], references: [callId])
  campaigns      Campaign?   @relation(fields: [campaignId], references: [campaignId])

  @@index([acknowledged])
  @@index([agentId])
  @@index([callId])
  @@index([createdAt])
  @@index([severity])
  @@index([type])
}

model automation_triggers {
  id           String     @id
  callId       String
  triggerType  String
  triggerData  String
  status       String     @default("PENDING")
  scheduledFor DateTime
  executedAt   DateTime?
  createdBy    String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  call_records CallRecord @relation(fields: [callId], references: [callId])

  @@index([callId])
  @@index([createdAt])
  @@index([scheduledFor])
  @@index([status])
  @@index([triggerType])
}

model call_analysis {
  id                      String     @id
  callId                  String     @unique
  agentId                 String?
  sentimentScore          Float
  sentiment               String
  confidence              Float
  emotions                String?
  urgency                 String?
  keywords                String?
  qualityScore            Int?
  currentMood             String?
  riskLevel               String?
  coachingRecommendations String?
  nextBestActions         String?
  complianceFlags         String?
  analyzedAt              DateTime   @default(now())
  updatedAt               DateTime
  agents                  Agent?     @relation(fields: [agentId], references: [id])
  call_records            CallRecord @relation(fields: [callId], references: [callId])

  @@index([agentId])
  @@index([analyzedAt])
  @@index([callId])
  @@index([riskLevel])
  @@index([sentiment])
}

model coaching_suggestions {
  id             String    @id
  callId         String
  agentId        String
  type           String
  message        String
  priority       String
  timestamp      DateTime
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  createdAt      DateTime  @default(now())

  @@index([acknowledged])
  @@index([agentId])
  @@index([callId])
  @@index([priority])
}

model compliance_alerts {
  id             String    @id
  callId         String
  agentId        String
  alertType      String
  severity       String
  description    String
  context        String?
  suggestion     String?
  requiresAction Boolean   @default(false)
  resolvedAt     DateTime?
  resolvedBy     String?
  createdAt      DateTime  @default(now())

  @@index([agentId])
  @@index([callId])
  @@index([requiresAction])
  @@index([severity])
}

model disposition_tracking {
  id            String      @id
  callId        String
  dispositionId String
  agentId       String
  timestamp     DateTime
  method        String
  confidence    Float?
  notes         String?
  createdAt     DateTime    @default(now())
  call_records  CallRecord  @relation(fields: [callId], references: [callId])
  dispositions  Disposition @relation(fields: [dispositionId], references: [id])

  @@index([agentId])
  @@index([callId])
  @@index([dispositionId])
  @@index([method])
  @@index([timestamp])
}

model dnc_numbers {
  id             Int      @id @default(autoincrement())
  phoneNumber    String   @unique @db.VarChar(20)
  originalFormat String   @db.VarChar(30)
  reason         String?
  addedBy        String   @db.VarChar(255)
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@index([createdAt])
  @@index([phoneNumber])
}

model flow_permissions {
  id                                            String    @id
  flowId                                        String
  userId                                        Int
  permissionType                                String
  grantedByUserId                               Int
  grantedAt                                     DateTime  @default(now())
  expiresAt                                     DateTime?
  flows                                         Flow      @relation(fields: [flowId], references: [id], onDelete: Cascade)
  users_flow_permissions_grantedByUserIdTousers User      @relation("flow_permissions_grantedByUserIdTousers", fields: [grantedByUserId], references: [id])
  users_flow_permissions_userIdTousers          User      @relation("flow_permissions_userIdTousers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flowId, userId, permissionType])
  @@index([flowId])
  @@index([userId])
}

model flow_shares {
  id              String       @id
  flowId          String
  sharedWithOrgId String
  sharedByUserId  Int
  accessType      String
  permissions     String?
  sharedAt        DateTime     @default(now())
  expiresAt       DateTime?
  isActive        Boolean      @default(true)
  flows           Flow         @relation(fields: [flowId], references: [id], onDelete: Cascade)
  users           User         @relation(fields: [sharedByUserId], references: [id])
  organizations   Organization @relation(fields: [sharedWithOrgId], references: [id], onDelete: Cascade)

  @@unique([flowId, sharedWithOrgId])
  @@index([flowId])
  @@index([sharedByUserId])
  @@index([sharedWithOrgId])
}

model flow_templates {
  id              String       @id
  name            String
  description     String
  category        String?
  tags            String?
  organizationId  String
  createdByUserId Int
  isPublic        Boolean      @default(false)
  usageCount      Int          @default(0)
  rating          Float?
  templateData    String
  previewImage    String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime
  users           User         @relation(fields: [createdByUserId], references: [id])
  organizations   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isPublic])
  @@index([organizationId])
}

model flow_version_rollbacks {
  id                                                                String      @id
  fromVersionId                                                     String
  toVersionId                                                       String
  reason                                                            String
  performedBy                                                       Int
  performedAt                                                       DateTime    @default(now())
  impactAnalysis                                                    String?
  flow_versions_flow_version_rollbacks_fromVersionIdToflow_versions FlowVersion @relation("flow_version_rollbacks_fromVersionIdToflow_versions", fields: [fromVersionId], references: [id])
  users                                                             User        @relation(fields: [performedBy], references: [id])
  flow_versions_flow_version_rollbacks_toVersionIdToflow_versions   FlowVersion @relation("flow_version_rollbacks_toVersionIdToflow_versions", fields: [toVersionId], references: [id])
}

model inbound_calls {
  id              String    @id
  callId          String    @unique
  callSid         String    @unique
  callerNumber    String
  contactId       String?
  status          String    @default("ringing")
  assignedAgentId String?
  assignedQueueId String?
  routingMetadata String?
  isCallback      Boolean   @default(false)
  priority        String    @default("normal")
  duration        Int?
  createdAt       DateTime  @default(now())
  answeredAt      DateTime?
  endedAt         DateTime?
  agents          Agent?    @relation(fields: [assignedAgentId], references: [agentId])
  contacts        Contact?  @relation(fields: [contactId], references: [contactId])
}

model lead_scores {
  id                    String   @id
  contactId             String   @unique
  score                 Float
  confidence            Float
  priority              String
  factors               String?
  nextBestAction        String?
  estimatedRevenue      Float?
  conversionProbability Float?
  timeToContact         Int?
  preferredChannel      String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime
  contacts              Contact  @relation(fields: [contactId], references: [contactId])

  @@index([contactId])
  @@index([priority])
  @@index([score])
}

model organization_analytics {
  id                   String       @id
  organizationId       String
  period               String
  periodStart          DateTime
  periodEnd            DateTime
  totalFlows           Int          @default(0)
  activeFlows          Int          @default(0)
  totalExecutions      Int          @default(0)
  successfulExecutions Int          @default(0)
  failedExecutions     Int          @default(0)
  avgExecutionTime     Float?
  avgSuccessRate       Float?
  totalResourceUsage   Float?
  activeUsers          Int          @default(0)
  newFlowsCreated      Int          @default(0)
  templatesUsed        Int          @default(0)
  createdAt            DateTime     @default(now())
  organizations        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, period, periodStart])
  @@index([organizationId])
  @@index([periodStart])
  @@index([period])
}

model quality_monitoring {
  id                   String     @id
  callId               String     @unique
  agentId              String
  monitoredBy          String?
  overallQuality       Int
  communicationSkills  Int?
  productKnowledge     Int?
  processAdherence     Int?
  customerSatisfaction Int?
  complianceScore      Int?
  strengths            String?
  improvementAreas     String?
  coachingNotes        String?
  scriptAdherence      Float?
  sentimentProgression String?
  complianceViolations String?
  followUpRequired     Boolean    @default(false)
  coachingScheduled    Boolean    @default(false)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime
  agents               Agent      @relation(fields: [agentId], references: [id])
  call_records         CallRecord @relation(fields: [callId], references: [callId])

  @@index([agentId])
  @@index([createdAt])
  @@index([monitoredBy])
  @@index([overallQuality])
}

model quality_scores {
  id                 String   @id
  callId             String   @unique
  agentId            String
  overallScore       Float
  communicationScore Float
  empathyScore       Float
  complianceScore    Float
  effectivenessScore Float
  createdAt          DateTime @default(now())

  @@index([agentId])
  @@index([overallScore])
}

model sentiment_analysis {
  id           String     @id
  callId       String
  agentId      String
  timestamp    DateTime
  sentiment    String
  confidence   Float
  transcript   String?
  emotions     String?
  intent       String?
  keywords     String?
  createdAt    DateTime   @default(now())
  call_records CallRecord @relation(fields: [callId], references: [callId])

  @@index([agentId])
  @@index([callId])
  @@index([sentiment])
  @@index([timestamp])
}

model SecurityEvent {
  id        String   @id @default(cuid())
  type      String   // SUSPICIOUS_REQUEST, FAILED_AUTH, UNAUTHORIZED_ACCESS, etc.
  ip        String
  userAgent String?
  email     String?
  endpoint  String?
  url       String?
  body      String?  // JSON string of request body
  severity  String   // LOW, MEDIUM, HIGH, CRITICAL
  createdAt DateTime @default(now())
  
  @@index([ip])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@map("security_events")
}

model UserSession {
  id               String    @id @default(cuid())
  sessionId        String    @unique
  userId           Int
  loginTime        DateTime  @default(now())
  logoutTime       DateTime?
  ipAddress        String?
  userAgent        String?
  status           String    @default("active") // 'active', 'logged_out', 'expired', 'forced_logout'
  lastActivity     DateTime  @default(now())
  sessionDuration  Int?      // in seconds, calculated on logout
  browserInfo      String?
  deviceType       String?
  locationInfo     String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([loginTime])
  @@index([logoutTime])
  @@index([sessionId])
  @@map("user_sessions")
}
